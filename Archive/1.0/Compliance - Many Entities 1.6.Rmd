---
title: "Many LG - Compliance v 1.5"
author: "Michael Jensen"
date: "May 2018"
output: html_notebook
---
#   ____________________________________________________________________________
#   File Description                                                        ####

**Purpose:**

Report the fiscal periods for which a local government is non-compliant with
the following Transparency reporting requirements:

* One expense transaction per fiscal quarter.
* One revenue transaction per fiscal quarter.
* One W-2 employee compensation transaction per fiscal year.

**Inputs:**

* report.qtr: The calendar year and quarter through which OSA will enforce 
  compliance for expense and revenue reporting.
* template.er: The expense and revenue reporting template.
* template.w2: The W-2 employee compensation reporting template.
* sf.master: A Salesforce report containing the following information for every 
  entity in OSA's Salesforce database (the title of the report I created in 
  Salesforce that contains this information is "Transparency - Master List"):
    + Entity Name
    + Entity ID (the entity's Salesforce ID)
    + Transparency ID
    + Entity Record Type
    + Entity Status
    + Expense/Revenue Start Date
    + Wage Start Date

**Outputs:**

A report containing the following:
* The name of every participating local entity that should
  be reporting to Transparency, with the exception of redevelopment agencies
  (they will be included in the next version of the Compliance Report).
* The fiscal periods for which an entity is missing a required report, if any.

**Comments:**

* This report does not take into account an entity's unique exemptions, nor 
  unique fiscal years if the fiscal year begins on a month other than January or
  July.
* On April 1, 2018 I changed the due date for the most recent employee 
  compensation report for all entities with a fiscal year end of Dec. 31, 2017
  to July 2018. We did not intend to enforce that information and so manually 
  removing "2017 COMP" from each entity that had a fiscal year end of Dec. 31, 
  2017 was more work than I was willing to do.  
  If this version is to be used in the future to determine which entities are 
  still missing 2017 COMP reports, some code in the MissingComp function will 
  need to be corrected.

#   ____________________________________________________________________________
#   Define Inputs                                                           ####

Through calendar year 2020, the only input that should be updated is report.qtr
(remember that report.qtr is the calendar year and quarter through which we will
enforce compliance).

```{r}
report.qtr <- 
  as.numeric(2017.4)

template.er <- 
  as.matrix(
    as.numeric(
      c("2013.1", "2013.2", "2013.3", "2013.4",
        "2014.1", "2014.2", "2014.3", "2014.4",
        "2015.1", "2015.2", "2015.3", "2015.4",
        "2016.1", "2016.2", "2016.3", "2016.4",
        "2017.1", "2017.2", "2017.3", "2017.4",
        "2018.1", "2018.2", "2018.3", "2018.4",
        "2019.1", "2019.2", "2019.3", "2019.4", 
        "2020.1", "2020.2", "2020.3", "2020.4")))

template.w2 <-
  as.matrix(
    as.numeric(
      c("2013",   "2014",   "2015",   "2016", 
        "2017",   "2018",   "2019",   "2020")))

sf.master <- 
  read.csv(
    file.choose(), 
    header = TRUE, 
    stringsAsFactors = FALSE)
```

#   ____________________________________________________________________________
#   Create the Compliance Report Template                                   ####

Filter the Salesforce report to retain only entities for which we will enforce
compliance with Transparency reporting requirements (note that RDAs are not 
included here, though they will be included in the next version).

```{r}
report <-
  subset(
    sf.master,
    subset = (
      Entity.Record.Type == "AOG" |
      Entity.Record.Type == "City" |
      Entity.Record.Type == "County" |
      Entity.Record.Type == "District Health" |
      Entity.Record.Type == "Housing" |
      Entity.Record.Type == "Interlocal" |
      Entity.Record.Type == "Local and Special Service District" |
      Entity.Record.Type == "Mental Health" |
      Entity.Record.Type == "School District or Charter School" |
      Entity.Record.Type == "Town"))

rm(sf.master)
```

Filter the report to remove entities with a status of Inactive or Dissolved, as
we do not track or enforce compliance for these entities.

```{r}
report <- 
  subset(
    report,
    subset = (
      Entity.Status != "Inactive" &
      Entity.Status != "Dissolved"))
```

Format date columns as date class values, rename the columns to keep, and drop 
the columns no longer needed.

```{r}
report[ , "Expense.Revenue.Start.Date"] <-
  as.Date(
    report[ , "Expense.Revenue.Start.Date"],
    format = "%m/%d/%Y")

report[ , "Wage.Start.Date"] <-
  as.Date(
    report[ , "Wage.Start.Date"],
    format = "%m/%d/%Y")

colnames(report)[1] <- "entity.name"
colnames(report)[2] <- "sf.id"
colnames(report)[3] <- "t.id"
colnames(report)[6] <- "begin.er"
colnames(report)[7] <- "begin.w2"

report <-
  subset(
    report,
    select = c("entity.name",
               "sf.id",
               "t.id",
               "begin.er",
               "begin.w2"))
```

Add columns to be populated during a later step.

```{r, results = 'hide'}
library(lubridate)

report$EXP            <- NA
report$REV            <- NA
report$COMP           <- NA
report$Analyst.Note   <- NA
report$Last.Upload    <- NA
report$Last.Processed <- NA
report$Report.Date    <- today()
```

#   ____________________________________________________________________________
#   Define Functions                                                        ####

##  ............................................................................
##  MissingExp                                                              ####

The MissingExp function:

* Queries the Transparency database for the entity's reported expense 
  transactions, summarized by calendar quarter.
    + Note that if an entity does not have a Transparency ID listed in 
      Salesforce I assume it is not reporting to Transparency and indicate that
      no transactions were reported. An entity may therefore be incorrectly 
      identified as having uploaded no transactions.
    + Note that summarizing by calendar quarter may later result in incorrectly
      identifying an entity's compliance status if that entity has fiscal 
      quarters that are different from calendar quarters.
    + Note that this code uses only an entity's reported posting dates to 
      determine compliance. This means that an entity is considered compliant as
      long as any posting date in the entirety of the entity's reporting history
      matches the required calendar quarter of reporting. In later versions this
      problem will be addressed by using the fiscal year to validate the posting
      date. 
* Modifies the expense and revenue reporting template based on the entity's 
  unique start date for reporting expense and revenue transactions.
* Compares the calendar quarters for which the entity did report data to the 
  quarters for which the entity should have reported data to find missing 
  periods, if any.
* Formats the missing periods and inserts them into the Compliance Report.

```{r}
MissingExp <- function(x, y) {
  
  # Args:
  #   x: The entity's Transparency ID.
  #   y: The entity's start date for reporting expense and revenue transactions
  #      (the code may result in an error if x has a value but y is NA).
  
  # Returns:
  #   Calendar quarters for which the entity is missing an expected expense 
  #   transaction.
  
  if (is.na(x) == TRUE) {
    missing.exp <- "No EXP reported"
  }
  
  if (is.na(x) == FALSE) {
    
    # Query the reported transactions.
    reported.exp <-
    as.matrix(
      sqlQuery(
        aws,
        paste("
              SELECT DISTINCT 
                CONCAT (YEAR(posting_date), '.', QUARTER(posting_date))
              FROM transaction
              WHERE batch_id IN (
                SELECT id
                FROM batch
                WHERE entity_id = ", x, "
                AND status IN ('PROCESSED', 'PROCESSING'))
              AND type = 1")))
    
    # Modify the reporting template.
    required.exp <-
    as.numeric(
      template.er[
        template.er >= 
          quarter(y, 
            with_year = TRUE)])
  
    required.exp <-
      required.exp[
        required.exp <= report.qtr]
  
    # Find any missing quarters.
    missing.exp <-
      as.data.frame(
        setdiff(
          required.exp,
          reported.exp))
  
    rm(required.exp, reported.exp)
  
    # Format missing quarters, if any.
    if (nrow(missing.exp) == 0) {
      missing.exp <- ""
    } else {
      missing.exp[ , 1] <-
      gsub("\\.1$", " JAN-MAR", missing.exp[ , 1])
  
    missing.exp[ , 1] <-
      gsub("\\.2$", " APR-JUN", missing.exp[ , 1])
  
    missing.exp[ , 1] <-
      gsub("\\.3$", " JUL-SEP", missing.exp[ , 1])
  
    missing.exp[ , 1] <-
      gsub("\\.4$", " OCT-DEC", missing.exp[ , 1])
  
    missing.exp <-
      paste(
        "EXP",
        missing.exp[ , 1], 
        collapse = ", ")
    }
  }
  
  # Report the missing periods.
  missing.exp
}
```

##  ............................................................................
##  MissingRev                                                              ####

The MissingRev function does the same thing as MissingExp, with the exception of
searching for type 2 (revenue) rather than type 1 (expense) transactions in AWS.

```{r}
MissingRev <- function(x, y) {
  
  # Args:
  #   x: The entity's Transparency ID.
  #   y: The entity's start date for reporting expense and revenue transactions
  #      (the code may result in an error if x has a value but y is NA).
  
  # Returns:
  #   Calendar quarters for which the entity is missing an expected revenue 
  #   transaction.
  
  if (is.na(x) == TRUE) {
    missing.rev <- "No REV reported"
  }
  
  if (is.na(x) == FALSE) {
    
    # Query the reported transactions.
    reported.rev <-
    as.matrix(
      sqlQuery(
        aws,
        paste("
              SELECT DISTINCT 
                CONCAT (YEAR(posting_date), '.', QUARTER(posting_date))
              FROM transaction
              WHERE batch_id IN (
                SELECT id
                FROM batch
                WHERE entity_id = ", x, "
                AND status IN ('PROCESSED', 'PROCESSING'))
              AND type = 2")))
    
    # Modify the reporting template.
    required.rev <-
    as.numeric(
      template.er[
        template.er >= 
          quarter(y, 
            with_year = TRUE)])
  
    required.rev <-
      required.rev[
        required.rev <= report.qtr]
  
    # Find any missing quarters.
    missing.rev <-
      as.data.frame(
        setdiff(
          required.rev,
          reported.rev))
  
    rm(required.rev, reported.rev)
  
    # Format missing quarters, if any.
    if (nrow(missing.rev) == 0) {
      missing.rev <- ""
    } else {
      missing.rev[ , 1] <-
      gsub("\\.1$", " JAN-MAR", missing.rev[ , 1])
  
    missing.rev[ , 1] <-
      gsub("\\.2$", " APR-JUN", missing.rev[ , 1])
  
    missing.rev[ , 1] <-
      gsub("\\.3$", " JUL-SEP", missing.rev[ , 1])
  
    missing.rev[ , 1] <-
      gsub("\\.4$", " OCT-DEC", missing.rev[ , 1])
  
    missing.rev <-
      paste(
        "REV",
        missing.rev[ , 1], 
        collapse = ", ")
    }
  }
  
  # Report the missing periods.
  missing.rev
}
```

##  ............................................................................
##  MissingW2                                                               ####

The MissingW2 function is similar to MissingExp and MissingRev, with the 
following exceptions:

* I query for type 3 (W-2 compensation) financial information.
* I use the fiscal_year variable to determine whether an entity has posted the
  required information, rather than the posting_date variable. 
    + This is due to the difference in how employee compensation information is 
    posted, as it is not general ledger information and therefore the posting 
    dates may not match the fiscal year.
* W-2 information is only required once per year, so I use a yearly template to
  determine compliance, rather than a quarterly one.

**Important Note:**

  As mentioned in the file description, I modified this code so that it will not
  report the missing 2017 W-2 compensation reports for entities with a fiscal 
  year that ends on December 31 until July 2018. I've made a note in the body of
  the MissingW2 function definition indicating where I made the change.

```{r}
MissingW2 <- function(x, y) {
  
  # Args:
  #   x: The entity's Transparency ID.
  #   y: The entity's start date for reporting W-2 compensation information
  #      (the code may result in an error if x has a value but y is NA).
  
  # Returns:
  #   Fiscal years for which the entity is missing an expected W-2 compensation 
  #   upload.
  
  if (is.na(x) == TRUE) {
    missing.w2 <- "No COMP reported"
  }
  
  if (is.na(x) == FALSE) {
    
    # Query the reported information.
    reported.w2 <-
      as.matrix(
        sqlQuery(
          aws,
          paste("
                SELECT DISTINCT fiscal_year
                FROM transaction
                WHERE batch_id IN (
                  SELECT id
                  FROM batch
                  WHERE entity_id = ", x, "
                  AND status IN ('PROCESSED', 'PROCESSING'))
                AND type = 3")))
  
    # Modify the reporting template.
    if (month(y) == 1) {
      required.w2 <- 
        template.w2[
          template.w2 >=
            as.numeric(
              year(y))]
    } else {
      required.w2 <-
        template.w2[
          template.w2 >
            as.numeric(
              year(y))]
    }
  
    # If it is not yet July 2018 and you want to include the missing 2017 W2 
    # reports, change "7" to "4" in the code below.
  
    if ((month(y) == 1) & (month(today()) < 7)) {
      required.w2 <-
        required.w2[
          required.w2 <
            (year(today()) - 1)]
    } else if ((month(y) == 1) & (month(today()) >= 7)) {
      required.w2 <-
        required.w2[
          required.w2 <
            year(today())]
    } else if ((month(y) != 1) & (month(today()) < 10)) {
     required.w2 <-
        required.w2[
          required.w2 <
            year(today())]
    } else if ((month(y) != 1) & (month(today()) >= 10)) {
      required.w2 <-
        required.w2[
         required.w2 <= 
            year(today())]
    }
    
    # Find any missing fiscal years.
    missing.w2 <- 
      as.data.frame(
        setdiff(
          required.w2, 
          reported.w2))
  
    rm(required.w2, reported.w2)
  
    # Format the missing years, if any.
    if (nrow(missing.w2) == 0) {
      missing.w2 <- ""
    } else {
     missing.w2 <-
       paste(
         "COMP",
         missing.w2[ , 1],
         collapse = ", ")
    }
  }
    
  # Report the missing years.
  missing.w2
}
```

##  ............................................................................
##  LastUploadedBatch                                                       ####

Determine the date of the most recently uploaded batch for each entity, so we 
have more information to use when speaking with local government officials.

```{r}
LastUploadedBatch <- function(x) {
  
  # Args:
  #   x: The entity's Transparency ID.
  
  # Returns:
  #   If present, the date of the most recently uploaded batch.
  #   If the entity has never uploaded a batch, "1900-01-01."
  
  if (is.na(x) == TRUE) {
    upload <- "1900-01-01"
  }

  if (is.na(x) == FALSE) {
    upload <- 
      as.matrix(
        sqlQuery(
        aws, 
        paste("
              SELECT DATE_FORMAT(upload_date, '%Y-%m-%d')
              FROM batch
              WHERE entity_id = ", x, "
              ORDER BY upload_date DESC
              LIMIT 1")))
    
    if (nrow(upload) == 0) {
      upload <- "1900-01-01"
    } else {
      upload <- upload[1]
    }
  }
  
  upload
}
```

##  ............................................................................
##  LastProcessedBatch                                                      ####

Determine the date of the most recently processed batch for each entity, so we
have more information to use when speaking with local government officials.

* Note that the date of the most recently processed batch is not always the 
  date the most recently uploaded batch was processed. This date value indicates 
  the most recent time when an action was taken on any of the entity's batch
  files.
  
```{r}
LastProcessedBatch <- function(x) {
  
  # Args:
  #   x: The entity's Transparency ID.
  
  # Returns:
  #   If present, the date of the most recently processed batch.
  #   If the entity has never had a batch processed, "1900-01-01."
  
  if (is.na(x) == TRUE) {
    process <- "1900-01-01"
  }

  if (is.na(x) == FALSE) {
    process <- 
      as.matrix(
        sqlQuery(
        aws, 
        paste("
              SELECT DATE_FORMAT(processed_date, '%Y-%m-%d')
              FROM batch
              WHERE entity_id = ", x, "
              ORDER BY processed_date DESC
              LIMIT 1")))
    
    if (nrow(process) == 0) {
      process <- "1900-01-01"
    } else {
      process <- process[1]
    }
  }
  
  process
}
```

#   ____________________________________________________________________________
#   Generate the Compliance Report                                          ####

Open the ODBC to AWS.

```{r, results = 'hide'}
library(RODBC)
aws <- odbcConnect("transpAWS")
```

Populate the report.

```{r}
for (i in 1:nrow(report)) {
  report[i, "EXP"] <-
    MissingExp(report[i, "t.id"], report[i, "begin.er"])
  
  report[i, "REV"] <-
    MissingRev(report[i, "t.id"], report[i, "begin.er"])
  
  report[i, "COMP"] <-
    MissingW2(report[i, "t.id"], report[i, "begin.w2"])
  
  report[i, "Last.Upload"] <-
    LastUploadedBatch(report[i, "t.id"])
  
  report[i, "Last.Processed"] <-
    LastProcessedBatch(report[i, "t.id"])
}
rm(i)
```

Prepare the report for export by excluding unnecessary columns and rearranging
the remaining ones.

```{r}
report <-
  report[ , c(12, 2, 3, 1, 6:11)]
```

Export the Compliance Report.

```{r}
write.csv(
  report,
  file = "S:/Localgov/LG Compliance/Transparency Compliance/Compliance Report.csv",
  row.names = FALSE)
```

#   ____________________________________________________________________________
#   Clean up the R Environment                                              ####

```{r}
odbcClose(aws)

detach(package:lubridate)
detach(package:RODBC)

rm(list = ls())
```
