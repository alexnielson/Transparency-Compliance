---
title: "Invalid Expense and Revenue Payee/Customer/Vendor Names"
author: "Michael Jensen"
date: "`r format(Sys.Date(), '%B %e, %Y')`"
output:
  html_document:
    df_print: paged
  pdf_document: default
---
***
### Introduction

The purpose of this report is to identify local governments with invalid payee/customer/vendor names for expense and revenue transactions.

**Background**

Transparency Board policy requires local governments to submit the payee, customer, or vendor name for expense and revenue transactions (*State of Utah Transparency Website File Layout*, August 28, 2013 revision). Board policy allows for two exceptions:

* Information that is permanently private, protected, or controlled must be replaced with "Not Provided."
* Transactions without a payee, customer, or vendor (such as a journal voucher) must be replaced with "Not Applicable."

The validity of "Not Provided" and "Not Applicable" submissions to Transparency has not been tested, however, and Auditor Dougall requested that I review the information. His intent is that seemingly invalid names are identified and the appropriate local governments are contacted in order to correct inaccuracies.

### Analysis

**Identifying Invalid Names**

```{r, message = FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Packages & Data Connections
library(odbc)
library(stringr)
library(tidyverse)

odbc_aws <- dbConnect(odbc::odbc(), "transpAWS")
odbc_sf  <- dbConnect(odbc::odbc(), "Salesforce") 
```

```{sql, connection=odbc_sf, results='hide'}
SELECT DISTINCT DeveloperName
FROM RecordType
WHERE DeveloperName NOT IN (
 'Chat', 'Community', 'Email', 'Phone', 'Social', 'CPA_Firm', 'Community_User',
 'Educational_Foundation', 'Financial_Institution', 'State_Agency',
 'Justice_Court', 'Non_Profits', 'Subpoena', 'LT_Gov_Document', 'Consolidation', 
 'AUP_Checklist', 'Budget_Checklist', 'LEA_Checklist', 'Large_Entity_Checklist',
 'Small_Entity_Checklist', 'Special_Purpose_Audit')
```

```{sql, connection=odbc_sf, output.var="active_local_govs"}
SELECT Transparency_ID__c AS transparency_id,
       Name               AS sf_entity_name
FROM Account
WHERE RecordTypeId IN (
  SELECT Id
  FROM RecordType
  WHERE DeveloperName IN (
    'AOG', 
    'City',
    'Conservation_District',
    'County', 
    'District_Health',     
    'Housing', 
    'Interlocal', 
    'Local_and_Special_Service_District', 
    'Mental_Health', 
    'Redevelopment_Agency_Project_Area', 
    'School_District_or_Charter_School',
    'Town'))
AND Entity_Status__c IN (
  'Current',
  'On hold',
  'Delinquent',
  'Suspended')
```

```{sql, connection=odbc_aws, results='hide'}
SELECT DISTINCT govt_lvl
FROM entity
```

```{sql, connection=odbc_aws, output.var="exp_vendor_names"}
SELECT DISTINCT vendor.id   AS vendor_id,
                vendor.name AS vendor_name,
                entity.id   AS transparency_id,
                entity.name AS entity_name
FROM vendor
LEFT JOIN entity
ON entity.id = vendor.entity_id
WHERE vendor.id IN(
  SELECT vendor_summary.vendor_id
  FROM vendor_summary
  WHERE type = 1)
AND vendor.entity_id IN (
  SELECT id
  FROM entity
  WHERE govt_lvl IN (
    'CITY',
    'COUNTY',
    'HOUSING AUTHORITIES',
    'INTERLOCAL',
    'INDEPENDENT',
    'K12 EDUCATION',
    'LOCAL DISTRICTS'
    'SERVICE DISTRICTS'))
```

```{sql, connection=odbc_aws, output.var="rev_vendor_names"}
SELECT DISTINCT vendor.id   AS vendor_id,
                vendor.name AS vendor_name,
                entity.id   AS transparency_id,
                entity.name AS entity_name
FROM vendor
LEFT JOIN entity
ON entity.id = vendor.entity_id
WHERE vendor.id IN(
  SELECT vendor_summary.vendor_id
  FROM vendor_summary
  WHERE type = 2)
AND vendor.entity_id IN (
  SELECT id
  FROM entity
  WHERE govt_lvl IN (
    'CITY',
    'COUNTY',
    'HOUSING AUTHORITIES',
    'INTERLOCAL',
    'INDEPENDENT',
    'K12 EDUCATION',
    'LOCAL DISTRICTS'
    'SERVICE DISTRICTS'))
```

```{r}
active_local_govs <- 
  as_tibble(active_local_govs)

exp_vendor_names <- 
  as_tibble(exp_vendor_names)

rev_vendor_names <- 
  as_tibble(rev_vendor_names)

exp_vendor_names$vendor_id <- 
  as.numeric(exp_vendor_names$vendor_id)

rev_vendor_names$vendor_id <- 
  as.numeric(rev_vendor_names$vendor_id)

exp_vendor_names$transparency_id <- 
  as.numeric(exp_vendor_names$transparency_id)

rev_vendor_names$transparency_id <- 
  as.numeric(rev_vendor_names$transparency_id)
```

```{r}
exp_vendor_names <- 
  exp_vendor_names %>% 
  semi_join(active_local_govs, by = "transparency_id")

rev_vendor_names <- 
  rev_vendor_names %>% 
  semi_join(active_local_govs, by = "transparency_id")

rm(active_local_govs)
```

```{r, eval=FALSE}
exp_distinct_names <- 
  exp_vendor_names %>% 
  distinct(vendor_name) %>% 
  arrange(vendor_name)

rev_distinct_names <- 
  rev_vendor_names %>% 
  distinct(vendor_name) %>% 
  arrange(vendor_name)

rm(exp_distinct_names, rev_distinct_names)
```

After excluding local governments that are inactive or dissolved, I searched for names that are blank, contain only numbers, or contain text like "Not Available", "Not Provided," "Unavailable", "NA," and "N/A." I found the following:

* Blank fields
* Fields containing some variation of "Not Provided"
* Fields containing some variation of "Not Available" (e.g., "N/A")
* Fields containing numbers unaccompanied by a name
* Fields containing incoherent or unhelpful names (e.g., a mixture of numbers and letters).

```{r, echo=FALSE}
exp_invalid_names <- 
  exp_vendor_names %>% 
  filter(vendor_name == "" |
         str_detect(vendor_name, regex("^not a", ignore_case = TRUE)) |
         str_detect(vendor_name, regex("^not pro", ignore_case = TRUE)) |
         str_detect(vendor_name, "^[0-9]+"))

rev_invalid_names <- 
  rev_vendor_names %>% 
  filter(vendor_name == "" |
         str_detect(vendor_name, regex("^not a", ignore_case = TRUE)) |
         str_detect(vendor_name, regex("^not pro", ignore_case = TRUE)) |
         str_detect(vendor_name, "^[0-9]+"))

exp_number_of_entities_with_invalid_names <- 
  exp_invalid_names %>% 
  distinct(entity_name) %>% 
  count() %>% 
  as.numeric()

rev_number_of_entities_with_invalid_names <- 
  rev_invalid_names %>% 
  distinct(entity_name) %>% 
  count() %>% 
  as.numeric()

exp_number_of_entities_with_not_provided <- 
  exp_invalid_names %>% 
  filter(str_detect(vendor_name, regex("^not pro", ignore_case = TRUE))) %>% 
  distinct(entity_name) %>% 
  count() %>% 
  as.numeric()

rev_number_of_entities_with_not_provided <- 
  rev_invalid_names %>% 
  filter(str_detect(vendor_name, regex("^not pro", ignore_case = TRUE))) %>% 
  distinct(entity_name) %>% 
  count() %>% 
  as.numeric()

exp_number_of_entities_with_blank_or_number <- 
  exp_invalid_names %>% 
  filter(vendor_name == "" |
         str_detect(vendor_name, "^[0-9]+")) %>% 
  distinct(entity_name) %>% 
  count() %>% 
  as.numeric()

rev_number_of_entities_with_blank_or_number <- 
  rev_invalid_names %>% 
  filter(vendor_name == "" |
         str_detect(vendor_name, "^[0-9]+")) %>% 
  distinct(entity_name) %>% 
  count() %>% 
  as.numeric()

exp_number_of_distinct_invalid_names <- 
  exp_invalid_names %>% 
  distinct(vendor_name) %>% 
  count() %>% 
  as.numeric()

rev_number_of_distinct_invalid_names <- 
  rev_invalid_names %>% 
  distinct(vendor_name) %>% 
  count() %>% 
  as.numeric()
```

For expenses, there are:

* `r exp_number_of_entities_with_invalid_names` vendor names that may be invalid.
* `r exp_number_of_distinct_invalid_names` unique vendor names.
* `r exp_number_of_entities_with_invalid_names` local governments with vendor names that may be invalid.
    + `r exp_number_of_entities_with_not_provided` local governments report at least one "Not Provided" vendor name.
    + `r exp_number_of_entities_with_blank_or_number` local governments report at least one blank name or a name including a number.

For revenues, there are:

* `r rev_number_of_entities_with_invalid_names` vendor names that may be invalid.
* `r rev_number_of_distinct_invalid_names` unique vendor names.
* `r rev_number_of_entities_with_invalid_names` local governments with vendor names that may be invalid.
    + `r rev_number_of_entities_with_not_provided` local governments report at least one "Not Provided" vendor name.
    + `r rev_number_of_entities_with_blank_or_number` local governments report at least one blank name or a name including a number. 
    
```{r}
rm(exp_number_of_distinct_invalid_names,
   exp_number_of_entities_with_blank_or_number,
   exp_number_of_entities_with_invalid_names,
   exp_number_of_entities_with_not_provided,
   rev_number_of_distinct_invalid_names,
   rev_number_of_entities_with_blank_or_number,
   rev_number_of_entities_with_invalid_names,
   rev_number_of_entities_with_not_provided)
```

**Expense Invalid Name Totals, by Entity**

```{r}
exp_total_vendors <- 
  exp_vendor_names %>% 
  group_by(entity_name) %>% 
  summarise(total_vendors = n())

exp_entity_totals <- 
  exp_invalid_names %>% 
  group_by(entity_name) %>% 
  summarise(invalid_vendor_count = n()) %>% 
  left_join(exp_total_vendors, by = "entity_name") %>% 
  mutate(percent_invalid = (invalid_vendor_count / total_vendors) * 100) %>% 
  mutate(percent_invalid = round(percent_invalid, digits = 1)) %>% 
  select(entity_name, percent_invalid, invalid_vendor_count, total_vendors) %>% 
  arrange(desc(percent_invalid), desc(invalid_vendor_count)) %>% 
  print()
```

**Revenue Invalid Name Totals, by Entity**

```{r}
rev_total_vendors <- 
  rev_vendor_names %>% 
  group_by(entity_name) %>% 
  summarise(total_vendors = n())

rev_entity_totals <- 
  rev_invalid_names %>% 
  group_by(entity_name) %>% 
  summarise(invalid_vendor_count = n()) %>% 
  left_join(rev_total_vendors, by = "entity_name") %>% 
  mutate(percent_invalid = (invalid_vendor_count / total_vendors) * 100) %>% 
  mutate(percent_invalid = round(percent_invalid, digits = 1)) %>% 
  select(entity_name, percent_invalid, invalid_vendor_count, total_vendors) %>% 
  arrange(desc(percent_invalid), desc(invalid_vendor_count)) %>% 
  print()
```

**Expense Invalid Name Totals, by Entity, by Invalid Name** 

```{r, echo=FALSE}
exp_by_name_totals <- 
  exp_invalid_names %>% 
  group_by(entity_name, vendor_name) %>% 
  summarise(name_count = n()) %>% 
  left_join(exp_total_vendors, by = "entity_name") %>% 
  mutate(percent_invalid = (name_count / total_vendors) * 100) %>% 
  mutate(percent_invalid = round(percent_invalid, digits = 1)) %>% 
  select(entity_name, vendor_name, percent_invalid, name_count, total_vendors) %>%
  arrange(desc(percent_invalid, desc(name_count))) %>% 
  print()
```

**Revenue Invalid Name Totals, by Entity, by Invalid Name** 

```{r, echo=FALSE}
rev_by_name_totals <- 
  rev_invalid_names %>% 
  group_by(entity_name, vendor_name) %>% 
  summarise(name_count = n()) %>% 
  left_join(rev_total_vendors, by = "entity_name") %>% 
  mutate(percent_invalid = (name_count / total_vendors) * 100) %>% 
  mutate(percent_invalid = round(percent_invalid, digits = 1)) %>% 
  select(entity_name, vendor_name, percent_invalid, name_count, total_vendors) %>%
  arrange(desc(percent_invalid, desc(name_count))) %>% 
  print()
```

## Local Government Specific Reports

```{r}
transparency_id <- 1231
```

```{sql, connection = odbc_aws, output.var = "exp_detail"}
SELECT DISTINCT 
  transaction.fiscal_year,
  transaction.posting_date,
  transaction.description,
  transaction.amount,
  transaction.org2,
  transaction.cat1,
  transaction.cat2,
  transaction.fund1,
  transaction.fund2,
  vendor.name AS vendor_name
FROM transaction
LEFT JOIN vendor 
  ON vendor.id = transaction.vendor_id
WHERE transaction.batch_id IN (
  SELECT id
  FROM batch
  WHERE entity_id = ?transparency_id
  AND status = 'PROCESSED')
AND transaction.type = 1
```

```{sql, connection = odbc_aws, output.var = "rev_detail"}
SELECT DISTINCT 
  transaction.fiscal_year,
  transaction.posting_date,
  transaction.description,
  transaction.amount,
  transaction.org2,
  transaction.cat1,
  transaction.cat2,
  transaction.fund1,
  transaction.fund2,
  vendor.name AS vendor_name
FROM transaction
LEFT JOIN vendor 
  ON vendor.id = transaction.vendor_id
WHERE transaction.batch_id IN (
  SELECT id
  FROM batch
  WHERE entity_id = ?transparency_id
  AND status = 'PROCESSED')
AND transaction.type = 2
```

```{sql, connection = odbc_aws, output.var = "transaction_group_table"}
SELECT id, name
FROM transaction_group
```

```{r}
exp_detail <- 
  exp_detail %>% 
  as.tibble()

rev_detail <- 
  rev_detail %>% 
  as.tibble()

transaction_group_table <- 
  transaction_group_table %>% 
  as.tibble()
```

```{r}
exp_detail <- 
  exp_detail %>% 
  left_join(transaction_group_table, by = c("org2" = "id")) %>% 
  rename(org2_name = name) %>% 
  left_join(transaction_group_table, by = c("cat1" = "id")) %>% 
  rename(cat1_name = name) %>% 
  left_join(transaction_group_table, by = c("cat2" = "id")) %>%
  rename(cat2_name = name) %>% 
  left_join(transaction_group_table, by = c("fund1" = "id")) %>%
  rename(fund1_name = name) %>% 
  left_join(transaction_group_table, by = c("fund2" = "id")) %>%
  rename(fund2_name = name) %>% 
  select(-c(org2, cat1, cat2, fund1, fund2)) %>% 
  arrange(posting_date)

rev_detail <- 
  rev_detail %>% 
  left_join(transaction_group_table, by = c("org2" = "id")) %>% 
  rename(org2_name = name) %>% 
  left_join(transaction_group_table, by = c("cat1" = "id")) %>% 
  rename(cat1_name = name) %>% 
  left_join(transaction_group_table, by = c("cat2" = "id")) %>%
  rename(cat2_name = name) %>% 
  left_join(transaction_group_table, by = c("fund1" = "id")) %>%
  rename(fund1_name = name) %>% 
  left_join(transaction_group_table, by = c("fund2" = "id")) %>%
  rename(fund2_name = name) %>% 
  select(-c(org2, cat1, cat2, fund1, fund2)) %>% 
  arrange(posting_date)
```

```{r}
entity_name <- 
  dbGetQuery(
    odbc_aws,
    paste("
          SELECT name
          FROM entity
          WHERE id = ", transparency_id)) %>% 
  as.character()

exp_path <- paste0(entity_name, " EXP.csv")
rev_path <- paste0(entity_name, " REV.csv")

write_csv(exp_detail, exp_path)

write_csv(rev_detail, rev_path)
```

## Close

```{r, echo=FALSE}
dbDisconnect(odbc_aws)
rm(list = ls())
```