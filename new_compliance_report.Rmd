---
title: "Transparency Compliance Report"
author: "Michael Jensen"
date: "February 2019"
output: html_notebook
---
# Program Description

**Purpose**

For the active and participating governments that OSA monitors for compliance with Transparency reporting requirements, report the fiscal periods for which the government does not have a permanent reporting exemption and has not complied with the following reporting requirements:

* One processed expense transaction per fiscal quarter.
* One processed revenue transaction per fiscal quarter.
* One processed W-2 employee compensation file per fiscal year.

**Input(s)**

* The DSN for the ODBC to AWS.
* The DSN for the ODBC to Salesforce.
* The date of the initial report of the previous compliance cycle if the compliance report is to be the initial report of a new compliance cycle.
* The date of the initial report of the current compliance cycle if the compliance report is to be a subsequent report.

```{r}
dsn_name_aws        <- "transpAWS"
dsn_name_salesforce <- "Salesforce"

# Insert a "#" before initial_report_date_previous_cycle if this is not the
# first report of the compliance enforcement cycle.
initial_report_date_previous_cycle <- as.Date("2018-08-01")

# Insert a "#" before initial_report_date_current_cycle if this is the first
# report of the compliance enforcement cycle.
# initial_report_date_current_cycle  <- as.Date("2019-02-04")
```

**Output(s)**

A report indicating whether a government is missing one or more required reports.

# Libraries and Data Sources

```{r}
library(lubridate)
library(magrittr)
library(odbc)
#library(splitstackshape) If I don't use this package, delete it.
library(svDialogs)
library(tidyverse)

odbc_aws <- dbConnect(odbc::odbc(), dsn_name_aws)
odbc_sf  <- dbConnect(odbc::odbc(), dsn_name_salesforce)
rm(dsn_name_aws, dsn_name_salesforce)
```

# Function Definitions

```{r}
query_initial_report <- function(initial_report_date) {
  # Query the initial compliance report for the previous or current enforcement
  # cycle.
  #
  # Args:
  #   initial_report_date (date): The date of the initial report.
  #
  # Returns:
  #   The compliance report for the input report date, as a tibble.
  
  # Modify the report date to match the format used in Salesforce:
  report_date <- 
    initial_report_date %>% 
    as.character() %>% 
    str_split("-") %>% 
    .[[1]] %>% 
    as.numeric()
  
  report_date <- 
    paste(report_date[2],
          report_date[3],
          report_date[1], sep = "/") %>% 
    paste0("'", ., "'")
  
  dbGetQuery(
    odbc_sf,
    paste("
          SELECT 
            t.Name                   AS report_date,
            a.Name                   AS name,
            t.Account__c             AS sf_id,
            t.Expenditure_Problem__c AS missing_exp,
            t.Revenue_Problem__c     AS missing_rev,
            t.Wage_Problem__c        AS missing_w2
          FROM (
            SELECT 
              Name, 
              Account__c, 
              Expenditure_Problem__c,
              Revenue_Problem__c, 
              Wage_Problem__c
            FROM Transparency_Reporting__c
            WHERE Name = ", report_date, ") t
          LEFT JOIN Account a 
          ON t.Account__c = a.Id")) %>% 
    as_tibble() %>% 
    mutate(report_date = as.Date(report_date, format = "%m/%d/%Y"))
}
```

```{r}
validate_report_length <- function(report_name, expected_rows) {
  # Verify that the length of the report rounds to the expected number of rows.
  #
  # Args:
  #   report_name: The name of the report to validate.
  #   expected_rows: The rounded number of rows the report is expected to have.
  
  if (!identical(expected_rows, 
                 report_name %>% nrow() %>% signif(1))) {
    
    paste0("The rounded number of rows in ", 
           deparse(substitute(report_name)),
          " is not near the expected ", 
          expected_rows, 
          ". Did the report import correctly? Did the number of entities we monitor change significantly?") %>% 
      stop()
  }
}
```

# Execution

```{r}
if (exists("initial_report_date_previous_cycle") &&
    exists("initial_report_date_current_cycle")) {
  
  stop("You may submit either initial_report_date_previous_cycle or
       initial_report_date_current_cycle, but not both.")
  
} else if (!exists("initial_report_date_previous_cycle") &&
           !exists("initial_report_date_current_cycle")) {
  
  stop("You must submit either initial_report_date_previous cycle or
       initial_report_date_current_cycle.")
  
} else if (exists("initial_report_date_previous_cycle")) {
  
  dlg_message(
    paste("You are about to create an INITIAL compliance report, using",
          initial_report_date_previous_cycle,
          "as the initial report date of the PREVIOUS cycle."),
    type = "ok")
  
  initial_report_date <- initial_report_date_previous_cycle
  
  names(initial_report_date) <- "previous_cycle_date"
  
  rm(initial_report_date_previous_cycle)
  
} else if (exists("initial_report_date_current_cycle")) {
  
  dlg_message(
    paste("You are about to create a SUBSEQUENT compliance report, using",
          initial_report_date_current_cycle,
          "as the initial report date of the CURRENT cycle."),
    type = "ok")
  
  initial_report_date <- initial_report_date_current_cycle
  
  names(initial_report_date) <- "current_cycle_date"
  
  rm(initial_report_date_current_cycle)
}
```

## Salesforce

```{sql, connection=odbc_sf, output.var=sf_local_gov_info}
SELECT 
  Name                          AS name, 
  Id                            AS sf_id,
  Transparency_ID__c            AS t_id, 
  Fiscal_Year_Begins__c         AS fy_begin_date,
  Expense_Revenue_Start_Date__c AS begin_report_exp_rev_date, 
  Wage_Start_Date__c            AS begin_report_w2_date
FROM Account
WHERE RecordTypeId IN (
  SELECT Id
  FROM RecordType
  WHERE DeveloperName IN (
  'AOG', 
  'City',
  'Conservation_District',
  'County', 
  'District_Health',     
  'Housing', 
  'Interlocal', 
  'Local_and_Special_Service_District', 
  'Mental_Health', 
  'Redevelopment_Agency_Project_Area', 
  'School_District_or_Charter_School',
  'Town'))
AND Entity_Status__c IN (
  'Current',
  'On hold',
  'Delinquent',
  'Suspended')
AND Name NOT IN (
  'Intermountain Power Agency', 
  'Utah Associated Municipal Power Systems', 
  'Utah Municipal Power Agency')
AND (
  Expense_Revenue_Start_Date__c <= DATE() OR 
  Expense_Revenue_Start_Date__c IS NULL)
```

```{sql, connection=odbc_sf, output.var=sf_independent_agency_info}
SELECT Name                          AS name, 
       Id                            AS sf_id,
       Transparency_ID__c            AS t_id, 
       Fiscal_Year_Begins__c         AS fy_begin_date,
       Expense_Revenue_Start_Date__c AS begin_report_exp_rev_date, 
       Wage_Start_Date__c            AS begin_report_w2_date
FROM Account
WHERE RecordTypeId IN (
  SELECT Id
  FROM RecordType
  WHERE DeveloperName IN (
  'State_Agency'))
AND Entity_Status__c IN (
  'Current',
  'On hold',
  'Delinquent',
  'Suspended')
AND Name IN (
  'Utah Dairy Commission', 
  'Heber Valley Historic Railroad Authority', 
  'Utah State Railroad Museum Authority',
  'Utah Housing Corporation',
  'Utah State Fair Corporation',
  'School and Institutional Trust Lands Administration',
  'School and Institutional Trust Fund Office',
  'Utah Communications Authority',
  'Utah Energy Infrastructure Authority',
  'Utah Capital Investment Corporation',
  'Military Installation Development Authority')
AND (
  Expense_Revenue_Start_Date__c <= DATE() OR 
  Expense_Revenue_Start_Date__c IS NULL)
```

```{r}
report_date <- 
  format(initial_report_date, "%Y/%m/%d") %>% 
  paste0("'", ., "'")

sf_status_history <- 
  dbGetQuery(
    odbc_sf,
    paste("
      SELECT 
        strftime('%Y/%m/%d', ValidFromDate) AS valid_from_date,
        Account__c_hst                      AS sf_id,
        Status__c_hst                       AS status
      FROM Transparency_Reporting__c_hd
      WHERE 
        strftime('%Y/%m/%d', ValidFromDate) >= strftime(", report_date, ")")) %>%
  left_join(sf_local_gov_info,
            by = "sf_id") %>% 
  select(name, sf_id, valid_from_date, status) %>% 
  arrange(name, valid_from_date) %>% 
  mutate(valid_from_date = as.Date(valid_from_date)) %>% 
  as_tibble()

rm(report_date)
```

```{r}
initial_report <-
  query_initial_report(initial_report_date)

rm(query_initial_report)
```

### Validate

```{r}
validate_report_length(sf_local_gov_info, 1000)
validate_report_length(sf_independent_agency_info, 10)
validate_report_length(initial_report, 1000)

rm(validate_report_length)
```

### Consolidate

```{r}
sf_data <- 
  list(initial_report = initial_report,
       entity_info    = sf_local_gov_info %>% 
                        bind_rows(sf_independent_agency_info) %>% 
                        as_tibble(),
       status_history = sf_status_history)

rm(initial_report,
   sf_local_gov_info,
   sf_independent_agency_info,
   sf_status_history)
```

# DBMS Disconnection

```{r}
dbDisconnect(odbc_aws)
dbDisconnect(odbc_sf)
```